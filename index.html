<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>급여 역산 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  </style>
</head>
<body class="p-4 bg-gray-100 flex items-center justify-center min-h-screen">

  <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
    <h1 class="text-3xl font-bold text-gray-800 text-center mb-4">급여 역산 계산기</h1>
    <p class="text-xs text-gray-500 text-center mb-6">
      실수령액을 입력하면 지급총액과 공제액을 역산하여 보여줍니다.<br>
      <span class="block mt-1">※ 2024 간이세액표(1인) + 4대보험 상·하한 + 10원 절사 반영</span>
    </p>

    <div class="mb-3">
      <label for="net_pay" class="block text-gray-700 font-semibold mb-2">실수령액 (원)</label>
      <input type="text" id="net_pay" inputmode="numeric"
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
             placeholder="예: 3,000,000">
    </div>

    <div class="mb-4">
      <label for="nontax" class="block text-gray-700 font-semibold mb-2">비과세 합계(월) — 식대/자가운전 등 (원)</label>
      <input type="text" id="nontax" inputmode="numeric"
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
             placeholder="예: 200,000 (없으면 0)">
      <p id="table_status" class="text-[11px] text-gray-400 mt-1">세액표 불러오는 중…</p>
    </div>

    <button id="calc_btn"
            class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
      계산하기
    </button>

    <div id="result" class="bg-gray-50 rounded-lg p-6 hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-4">계산 결과</h2>
      <div class="space-y-3">
        <div class="flex justify-between items-center pb-2 border-b border-gray-200">
          <span class="text-gray-600">지급총액</span>
          <span id="gross_pay_result" class="font-bold text-gray-900"></span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-600">공제액 합계</span>
          <span id="deductions_total_result" class="font-bold text-gray-900"></span>
        </div>
      </div>

      <div class="mt-6">
        <h3 class="text-lg font-bold text-gray-700 mb-2">세부 공제 내역 (추정)</h3>
        <ul class="text-sm text-gray-500 space-y-1">
          <li class="flex justify-between"><span>국민연금 (4.5%)</span> <span id="np_deduction"></span></li>
          <li class="flex justify-between"><span>건강보험 (3.55%)</span> <span id="hi_deduction"></span></li>
          <li class="flex justify-between"><span>장기요양보험 (건보료의 12.95%)</span> <span id="ltc_deduction"></span></li>
          <li class="flex justify-between"><span>고용보험 (0.9%)</span> <span id="ei_deduction"></span></li>
          <li class="flex justify-between"><span>소득세 (간이세액표)</span> <span id="tax_deduction"></span></li>
          <li class="flex justify-between"><span>지방소득세 (소득세의 10%)</span> <span id="local_tax_deduction"></span></li>
        </ul>
        <p class="text-[11px] text-gray-400 mt-2">※ 4대보험/세액 모두 10원 단위 절사.</p>
      </div>
    </div>

    <div id="error_message" class="text-center text-red-500 mt-4 hidden">
      유효한 금액을 입력해 주세요.
    </div>
  </div>

  <script>
    // ===== 입력창 천단위 콤마 처리 =====
    function bindCommaInput(el) {
      el.addEventListener('input', (e) => {
        const digits = e.target.value.replace(/[^\d]/g, '');
        if (!digits) { e.target.value = ''; return; }
        e.target.value = new Intl.NumberFormat('ko-KR').format(Number(digits));
      });
    }
    const netInput = document.getElementById('net_pay');
    const nonTaxInput = document.getElementById('nontax');
    bindCommaInput(netInput);
    bindCommaInput(nonTaxInput);

    // ===== 상수: 보수월액 상·하한 (원) =====
    const NP_MIN = 390_000;     // 국민연금 하한
    const NP_MAX = 6_170_000;   // 국민연금 상한
    const HI_MIN = 279_266;     // 건강보험 하한
    const HI_MAX = 127_056_982; // 건강보험 상한

    // ===== 4대보험 요율(근로자부담) =====
    const NP_RATE  = 0.0450; // 국민연금
    const HI_RATE  = 0.0355; // 건강보험 (3.55%)
    const LTC_RATE = 0.1295; // 장기요양: "건강보험료"의 12.95%
    const EI_RATE  = 0.0090; // 고용보험

    // ===== 전역 상태 =====
    let TAX_TABLE = []; // [{min_won, max_won, tax}, ...]
    let tableReady = false;

    // ===== 세액표 로딩 =====
    const statusEl = document.getElementById('table_status');
    const calcBtn = document.getElementById('calc_btn');

    async function loadTaxTable() {
      try {
        const resp = await fetch('./simplified_tax_table_2024_1person.json', { cache: 'no-store' });
        if (!resp.ok) throw new Error('세액표 파일을 불러오지 못했습니다.');
        TAX_TABLE = await resp.json();
        TAX_TABLE.sort((a, b) => a.min_won - b.min_won);
        tableReady = true;
        statusEl.textContent = '세액표 로드 완료';
        calcBtn.disabled = false;
      } catch (err) {
        statusEl.textContent = '세액표 로드 실패: ' + err.message;
        calcBtn.disabled = true;
      }
    }
    loadTaxTable();

    // ===== 유틸 =====
    const fmt = (num) => new Intl.NumberFormat('ko-KR').format(Math.round(num)) + ' 원';
    const toNumber = (el) => parseFloat((el.value || '0').replace(/[^\d]/g, '')) || 0;
    const trunc10 = (v) => Math.floor(v / 10) * 10;
    const clamp = (x, lo, hi) => Math.min(Math.max(x, lo), hi);

    // 표에서 특정 월급여(비과세 제외) 구간 세액 조회
    function _lookupTaxFromTable(monthlyGrossExclNT) {
      if (!tableReady || !Array.isArray(TAX_TABLE) || TAX_TABLE.length === 0) {
        return { found: false, tax: 0 };
      }
      let lo = 0, hi = TAX_TABLE.length - 1;
      while (lo <= hi) {
        const mid = (lo + hi) >> 1;
        const row = TAX_TABLE[mid];
        if (monthlyGrossExclNT < row.min_won) {
          hi = mid - 1;
        } else if (monthlyGrossExclNT >= row.max_won) {
          lo = mid + 1;
        } else {
          return { found: true, tax: Number(row.tax) || 0 };
        }
      }
      return { found: false, tax: 0 };
    }

    // 1천만원 구간의 표기준 세액
    function _taxAt10M() {
      const res = _lookupTaxFromTable(10_000_000);
      return res.found ? res.tax : 0;
    }

    // 간이세액표(1인) + 고액구간 조견식
    function getSimplifiedTaxFromTable(monthlyGrossExclNT) {
      const tableRes = _lookupTaxFromTable(monthlyGrossExclNT);
      if (tableRes.found) return tableRes.tax;

      const base10M = _taxAt10M();
      const g = monthlyGrossExclNT;

      if (g > 10_000_000 && g <= 14_000_000) {
        return base10M + 0.35 * 0.98 * (g - 10_000_000) + 25_000;
      } else if (g > 14_000_000 && g <= 28_000_000) {
        return base10M + 1_397_000 + 0.38 * 0.98 * (g - 14_000_000);
      } else if (g > 28_000_000 && g <= 30_000_000) {
        return base10M + 6_610_600 + 0.40 * 0.98 * (g - 28_000_000);
      } else if (g > 30_000_000 && g <= 45_000_000) {
        return base10M + 7_394_600 + 0.40 * (g - 30_000_000);
      } else if (g > 45_000_000 && g <= 87_000_000) {
        return base10M + 13_394_600 + 0.42 * (g - 45_000_000);
      } else if (g > 87_000_000) {
        return base10M + 31_034_600 + 0.45 * (g - 87_000_000);
      }

      const first = TAX_TABLE[0];
      return Number(first?.tax) || 0;
    }

    // ===== 메인 계산 =====
    const resultDiv = document.getElementById('result');
    const errDiv = document.getElementById('error_message');
    document.getElementById('calc_btn').addEventListener('click', calculateGrossPay);

    function calculateGrossPay() {
      if (!tableReady) { statusEl.textContent = '세액표가 아직 준비되지 않았습니다.'; return; }

      const netPay = toNumber(netInput);
      const nonTax = toNumber(nonTaxInput); // 비과세 합계(월)
      if (netPay <= 0) {
        resultDiv.classList.add('hidden');
        errDiv.classList.remove('hidden');
        return;
      }

      // 초기 추정치(상·하한 무시한 근사치)로 시작 → 반복수렴
      let approxRate = NP_RATE + HI_RATE + (HI_RATE * LTC_RATE) + EI_RATE;
      let grossPay = netPay / (1 - approxRate);

      const maxIterations = 150;
      for (let i = 0; i < maxIterations; i++) {
        const baseForTax = Math.max(grossPay - nonTax, 0); // 간이세액표 기준: 비과세 제외
        // 보험료 산정 기준: 보수월액(여기서는 세전총액 기준으로 보고 상·하한 clamp)
        const baseNP = clamp(grossPay, NP_MIN, NP_MAX);
        const baseHI = clamp(grossPay, HI_MIN, HI_MAX);
        const baseEI = grossPay; // 고용보험 한도 없음 가정

        // 4대보험 계산 (10원 절사)
        const np  = trunc10(baseNP * NP_RATE);
        const hi  = trunc10(baseHI * HI_RATE);
        const ltc = trunc10(hi * LTC_RATE);      // 장기요양은 "건보료의" 12.95%
        const ei  = trunc10(baseEI * EI_RATE);

        // 간이세액표 (비과세 제외 금액)
        const incomeTax = trunc10(getSimplifiedTaxFromTable(baseForTax));
        const localTax  = trunc10(incomeTax * 0.1);

        const totalDed  = np + hi + ltc + ei + incomeTax + localTax;
        const currentNet = grossPay - totalDed;

        const diff = netPay - currentNet;
        if (Math.abs(diff) < 1) break;
        grossPay += diff;
      }

      // 최종 산출·표시
      const baseForTax = Math.max(grossPay - nonTax, 0);
      const baseNP = clamp(grossPay, NP_MIN, NP_MAX);
      const baseHI = clamp(grossPay, HI_MIN, HI_MAX);
      const baseEI = grossPay;

      const np  = trunc10(baseNP * NP_RATE);
      const hi  = trunc10(baseHI * HI_RATE);
      const ltc = trunc10(hi * LTC_RATE);
      const ei  = trunc10(baseEI * EI_RATE);
      const incomeTax = trunc10(getSimplifiedTaxFromTable(baseForTax));
      const localTax  = trunc10(incomeTax * 0.1);
      const totalDed  = np + hi + ltc + ei + incomeTax + localTax;

      document.getElementById('gross_pay_result').textContent        = fmt(grossPay);
      document.getElementById('deductions_total_result').textContent = fmt(totalDed);
      document.getElementById('np_deduction').textContent            = fmt(np);
      document.getElementById('hi_deduction').textContent            = fmt(hi);
      document.getElementById('ltc_deduction').textContent           = fmt(ltc);
      document.getElementById('ei_deduction').textContent            = fmt(ei);
      document.getElementById('tax_deduction').textContent           = fmt(incomeTax);
      document.getElementById('local_tax_deduction').textContent     = fmt(localTax);

      resultDiv.classList.remove('hidden');
      errDiv.classList.add('hidden');
    }
  </script>
</body>
</html>
