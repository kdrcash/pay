<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>네트급여 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:'Inter',sans-serif;background:#f3f4f6}</style>
</head>
<body class="p-4 bg-gray-100 flex items-center justify-center min-h-screen">

  <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
    <h1 class="text-3xl font-bold text-gray-800 text-center mb-4">네트급여 계산기</h1>

    <p class="text-xs text-gray-500 text-center mb-6">
      <button id="ver_btn" type="button"
              class="inline-flex items-center text-blue-600 font-semibold underline hover:text-blue-800">
        Ver 1.0
      </button>
    </p>

    <div class="mb-3">
      <label class="block text-gray-700 font-semibold mb-2">실수령액 (원)</label>
      <input id="net_pay" type="text" inputmode="numeric"
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
             placeholder="예: 11,350,000">
    </div>

    <div class="mb-4">
      <label class="block text-gray-700 font-semibold mb-2">비과세 합계(월) — 식대/자가운전 등 (원)</label>
      <input id="nontax" type="text" inputmode="numeric"
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
             placeholder="예: 200,000 (없으면 0)">
      <p id="table_status" class="text-[11px] text-gray-400 mt-1">세액표 불러오는 중…</p>
    </div>

    <button id="calc_btn"
            class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>계산하기</button>

    <div id="result" class="bg-gray-50 rounded-lg p-6 hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-4">계산 결과</h2>

      <div class="space-y-1 text-sm font-mono">
        <div class="flex justify-between"><span class="text-gray-600">+ 4대보험 총액(근로자+사업주)</span><span id="social_total_summary" class="font-bold text-gray-900"></span></div>
        <div class="flex justify-between"><span class="text-gray-600">+ 원천세 총액(소득세+지방소득세)</span><span id="withholding_total_summary" class="font-bold text-gray-900"></span></div>
        <div class="border-t border-gray-300 my-1"></div>
        <div class="flex justify-between"><span class="text-gray-600">= 부대비용 총액(퇴직금 제외)</span><span id="overhead_excl_gratuity" class="font-bold text-gray-900"></span></div>
        <div class="flex justify-between"><span class="text-gray-600">+ 퇴직금 (지급총액의 1/12)</span><span id="gratuity_summary" class="font-bold text-gray-900"></span></div>
        <div class="border-t border-gray-300 my-1"></div>
        <div class="flex justify-between"><span class="text-gray-600">= 부대비용 총액(퇴직금 포함)</span><span id="overhead_incl_gratuity" class="font-bold text-gray-900"></span></div>
      </div>

      <div class="mt-6">
        <h3 class="text-lg font-bold text-gray-700 mb-2">세부 공제 내역</h3>
        <ul class="text-sm text-gray-500 space-y-1">
          <li class="flex justify-between"><span>국민연금 (4.5%)</span><span id="np_deduction"></span></li>
          <li class="flex justify-between"><span>건강보험 (3.545%)</span><span id="hi_deduction"></span></li>
          <li class="flex justify-between"><span>장기요양 (건보료의 12.95%)</span><span id="ltc_deduction"></span></li>
          <li class="flex justify-between"><span>고용보험 (0.9%)</span><span id="ei_deduction"></span></li>
          <li class="flex justify-between"><span>소득세 (간이세액표)</span><span id="tax_deduction"></span></li>
          <li class="flex justify-between"><span>지방소득세 (10%)</span><span id="local_tax_deduction"></span></li>
        </ul>

        <!-- 사업주 부담분 -->
        <div class="mt-6 border-t pt-4">
          <h4 class="text-base font-bold text-gray-700 mb-2">사업주 부담분</h4>
          <ul class="text-sm text-gray-600 space-y-1">
            <li class="flex justify-between"><span>국민연금 (4.5%)</span><span id="np_er"></span></li>
            <li class="flex justify-between"><span>건강보험 (3.545%)</span><span id="hi_er"></span></li>
            <li class="flex justify-between"><span>장기요양 (건보료의 12.95%)</span><span id="ltc_er"></span></li>
            <li class="flex justify-between"><span>고용보험 (1.15%)</span><span id="ei_er"></span></li>
            <li class="flex justify-between"><span>산재보험 (0.72%)</span><span id="wci_er"></span></li>
            <li class="flex justify-between font-semibold pt-1"><span>4대보험 사업주 부담분</span><span id="er_total"></span></li>
          </ul>
        </div>
      </div>
    </div>

    <div id="error_message" class="text-center text-red-500 mt-4 hidden">유효한 금액을 입력해 주세요.</div>
  </div>

  <script>
    function fmt(n){ return new Intl.NumberFormat('ko-KR').format(Math.round(n))+' 원'; }

    const netInput = document.getElementById('net_pay');
    const nonTaxInput = document.getElementById('nontax');
    const bindComma = el => el.addEventListener('input', e => {
      const d = e.target.value.replace(/[^\d]/g,'');
      e.target.value = d ? new Intl.NumberFormat('ko-KR').format(+d) : '';
    });
    bindComma(netInput); bindComma(nonTaxInput);

    const NP_MIN=400_000, NP_MAX=6_370_000;
    const HI_MIN=279_266, HI_MAX=127_056_982;
    const NP_RATE=0.0450, HI_RATE=0.03545, LTC_RATE=0.1295, EI_RATE=0.0090;
    const NP_ER_RATE=0.0450, HI_ER_RATE=0.03545, LTC_ER_RATE=0.1295, EI_ER_RATE=0.0115, WCI_ER_RATE=0.0072;
    const BASE10_1PERSON_RAW=1_507_405;
    const trunc10=v=>Math.floor(v/10)*10, clamp=(x,lo,hi)=>Math.min(Math.max(x,lo),hi);
    const num=el=>parseFloat((el.value||'0').replace(/[^\d]/g,''))||0;

    let TAX_TABLE=[], tableReady=false;
    const statusEl=document.getElementById('table_status');
    async function loadTax(){
      async function tryFetch(path){
        const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
      }
      try{
        try { TAX_TABLE = await tryFetch('./simplified_tax_table_2024_1person.v2.json'); }
        catch { TAX_TABLE = await tryFetch('./simplified_tax_table_2024_1person.json'); }
        TAX_TABLE.sort((a,b)=>a.min_won-b.min_won);
        tableReady=true; statusEl.textContent='세액표 로드 완료';
        document.getElementById('calc_btn').disabled=false;
      }catch(e){ statusEl.textContent='세액표 로드 실패: '+e.message; }
    }
    loadTax();

    function lookupTable(x){
      let lo=0,hi=TAX_TABLE.length-1;
      while(lo<=hi){
        const m=(lo+hi)>>1,row=TAX_TABLE[m];
        if(x<row.min_won) hi=m-1; else if(x>=row.max_won) lo=m+1;
        else return {found:true,tax:+row.tax||0};
      }
      return {found:false,tax:0};
    }

    function simplifiedTax(amountExclNT){
      const r=lookupTable(amountExclNT);
      if(r.found) return trunc10(r.tax);
      const g=amountExclNT,b10=BASE10_1PERSON_RAW; let t=b10;
      if(g>10_000_000&&g<=14_000_000) t += 25_000 + 0.35*0.98*(g-10_000_000);
      else if(g>14_000_000&&g<=28_000_000) t += 1_397_000 + 0.38*0.98*(g-14_000_000);
      else if(g>28_000_000&&g<=30_000_000) t += 6_610_600 + 0.40*0.98*(g-28_000_000);
      else if(g>30_000_000&&g<=45_000_000) t += 7_394_600 + 0.40*(g-30_000_000);
      else if(g>45_000_000&&g<=87_000_000) t += 13_394_600 + 0.42*(g-45_000_000);
      else if(g>87_000_000)               t += 31_034_600 + 0.45*(g-87_000_000);
      return trunc10(t);
    }

    document.getElementById('calc_btn').addEventListener('click', calc);
    function calc(){
      if(!tableReady){ statusEl.textContent='세액표가 아직 준비되지 않았습니다.'; return; }
      const netPay=num(netInput), nonTax=num(nonTaxInput);
      if(netPay<=0){ document.getElementById('result').classList.add('hidden'); return; }

      let approx = NP_RATE+HI_RATE+(HI_RATE*LTC_RATE)+EI_RATE;
      let gross = netPay/(1-approx);

      for(let i=0;i<160;i++){
        const baseIns=Math.max(gross-nonTax,0);
        const npBaseRaw=Math.floor(baseIns/1000)*1000;
        const baseNP=clamp(npBaseRaw,NP_MIN,NP_MAX);
        const baseHI=clamp(baseIns,HI_MIN,HI_MAX), baseEI=baseIns;
        const np=trunc10(baseNP*NP_RATE), hi=trunc10(baseHI*HI_RATE), ltc=trunc10(hi*LTC_RATE), ei=trunc10(baseEI*EI_RATE);
        const tax=trunc10(simplifiedTax(baseIns)), ltax=trunc10(tax*0.1);
        const total=np+hi+ltc+ei+tax+ltax;
        const newGross=netPay+total;
        if(Math.abs(newGross-gross)<1){gross=newGross;break;} gross=newGross;
      }

      const baseIns=Math.max(gross-nonTax,0);
      const npBaseRaw=Math.floor(baseIns/1000)*1000, baseNP=clamp(npBaseRaw,NP_MIN,NP_MAX);
      const baseHI=clamp(baseIns,HI_MIN,HI_MAX), baseEI=baseIns;
      const np=trunc10(baseNP*NP_RATE), hi=trunc10(baseHI*HI_RATE), ltc=trunc10(hi*LTC_RATE), ei=trunc10(baseEI*EI_RATE);
      const tax=trunc10(simplifiedTax(baseIns)), ltax=trunc10(tax*0.1);
      const np_er=trunc10(baseNP*NP_ER_RATE), hi_er=trunc10(baseHI*HI_ER_RATE), ltc_er=trunc10(hi_er*LTC_ER_RATE);
      const ei_er=trunc10(baseEI*EI_ER_RATE), wci_er=trunc10(baseEI*WCI_ER_RATE);
      const er_total=np_er+hi_er+ltc_er+ei_er+wci_er;
      const social_total=(np+hi+ltc+ei)+(er_total);
      const withholding_total=tax+ltax;
      const gratuity=Math.round(gross/12);
      const overhead_excl=social_total+withholding_total;
      const overhead_incl=overhead_excl+gratuity;

      document.getElementById('social_total_summary').textContent=fmt(social_total);
      document.getElementById('withholding_total_summary').textContent=fmt(withholding_total);
      document.getElementById('overhead_excl_gratuity').textContent=fmt(overhead_excl);
      document.getElementById('gratuity_summary').textContent=fmt(gratuity);
      document.getElementById('overhead_incl_gratuity').textContent=fmt(overhead_incl);

      document.getElementById('np_deduction').textContent=fmt(np);
      document.getElementById('hi_deduction').textContent=fmt(hi);
      document.getElementById('ltc_deduction').textContent=fmt(ltc);
      document.getElementById('ei_deduction').textContent=fmt(ei);
      document.getElementById('tax_deduction').textContent=fmt(tax);
      document.getElementById('local_tax_deduction').textContent=fmt(ltax);
      document.getElementById('np_er').textContent=fmt(np_er);
      document.getElementById('hi_er').textContent=fmt(hi_er);
      document.getElementById('ltc_er').textContent=fmt(ltc_er);
      document.getElementById('ei_er').textContent=fmt(ei_er);
      document.getElementById('wci_er').textContent=fmt(wci_er);
      document.getElementById('er_total').textContent=fmt(er_total);

      document.getElementById('result').classList.remove('hidden');
    }
  </script>
</body>
</html>
